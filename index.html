<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --bg-hover: #f1f3f5;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --accent-primary: #6366f1;
            --accent-hover: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }

        body {
            font-family: Inter, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: var(--accent-primary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .stat-label { color: var(--text-secondary); font-size: 0.875rem; }

        .stat-value {
            font-size: 2.4rem;
            font-weight: 700;
            margin-top: .5rem;
        }

        .chart-card, .leads-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }
    </style>
</head>

<body>

<header class="header">
    <div class="logo">üè† Estate Pro</div>
    <div class="avatar">RA</div>
</header>

<main class="container">

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Leads</div>
            <div class="stat-value" id="totalLeads">-</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Last 24 Hours</div>
            <div class="stat-value" id="leads24h">-</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Last 7 Days</div>
            <div class="stat-value" id="leads7d">-</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Avg Lead Score</div>
            <div class="stat-value" id="avgScore">-</div>
        </div>
    </div>

    <div class="chart-card">
        <h2>Leads Over Time (Last 7 Days)</h2>
        <canvas id="leadsChart"></canvas>
    </div>

    <div class="leads-card">
        <h2>Recent Leads</h2>
        <div id="leadsTableContainer" class="loading">Loading...</div>
    </div>

</main>

<script>
let allLeads = [];
let leadsChart = null;

async function fetchDashboardData() {
    try {
        const response = await fetch("https://krixsai.app.n8n.cloud/webhook/dashboard");
        const data = await response.json();

        if (!data || !data.leads) {
            throw new Error("Invalid data");
        }

        allLeads = data.leads;
        updateStats(data);
        updateLeadsTable(allLeads);
        updateChart(allLeads);

    } catch (err) {
        console.error("Fetch error:", err);

        document.getElementById("leadsTableContainer").innerHTML = `
            <div class="loading">
                ‚ùå Failed to load dashboard data
            </div>
        `;
    }
}

function updateStats(data) {
    document.getElementById("totalLeads").textContent = data.total_leads;
    document.getElementById("leads24h").textContent = data.leads_last_24h;
    document.getElementById("leads7d").textContent = data.leads_last_7_days;
    document.getElementById("avgScore").textContent = data.average_lead_score;
}

function updateLeadsTable(leads) {
    const container = document.getElementById("leadsTableContainer");

    if (!leads.length) {
        container.innerHTML = `
            <div class="loading">
                üì≠ No leads found
            </div>
        `;
        return;
    }

    const table = `
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Contact</th>
                    <th>Area</th>
                    <th>Intent</th>
                    <th>Score</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                ${leads.map(l => `
                    <tr>
                        <td>${l.Name || "N/A"}</td>
                        <td>${l.Email || "N/A"}<br><small>${l.Phone || ""}</small></td>
                        <td>${l.Area || "N/A"}</td>
                        <td>${l.Intent || "N/A"}</td>
                        <td>${l["Lead Score"] || 0}</td>
                        <td>${l.Date || "N/A"}</td>
                    </tr>
                `).join("")}
            </tbody>
        </table>
    `;

    container.innerHTML = table;
}

function updateChart(leads) {
    const ctx = document.getElementById("leadsChart");

    const days = [];
    const counts = [];

    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const day = d.toISOString().split("T")[0];
        const label = d.toLocaleDateString("en-US", { month: "short", day: "numeric" });

        days.push(label);
        counts.push(leads.filter(x => x.Date && x.Date.startsWith(day)).length);
    }

    if (leadsChart) leadsChart.destroy();

    leadsChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: days,
            datasets: [{
                label: "New Leads",
                data: counts,
                borderColor: "#6366f1",
                backgroundColor: "rgba(99,102,241,0.2)"
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });
}

fetchDashboardData();
</script>

</body>
</html>
