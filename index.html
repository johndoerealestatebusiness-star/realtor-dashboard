<script>
// Theme Toggle
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');
const html = document.documentElement;

const savedTheme = localStorage.getItem('theme') || 'light';
html.setAttribute('data-theme', savedTheme);
themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

themeToggle.addEventListener('click', () => {
    const current = html.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    themeIcon.textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
});

// Global data
let allLeads = [];
let leadsChart = null;

// Fetch Dashboard Data
async function fetchDashboardData() {
    try {
        const response = await fetch('https://krixsai.app.n8n.cloud/webhook/dashboard', {
            method: "GET",
            mode: "cors",
            cache: "no-store"
        });

        const data = await response.json();

        allLeads = data.leads || [];

        updateStats(data);
        updateLeadsTable(allLeads);
        updateChart(allLeads);

    } catch (error) {
        console.error('Dashboard Fetch Error:', error);
        document.getElementById('leadsTableContainer').innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">‚ö†Ô∏è</div>
                <p>Failed to load dashboard data</p>
            </div>
        `;
    }
}

// Update Stats
function updateStats(data) {
    document.getElementById('totalLeads').textContent = data.total_leads || 0;
    document.getElementById('leads24h').textContent = data.leads_last_24h || 0;
    document.getElementById('leads7d').textContent = data.leads_last_7_days || 0;
    document.getElementById('avgScore').textContent = data.average_lead_score || 0;
}

// Update Leads Table
function updateLeadsTable(leads) {
    const container = document.getElementById('leadsTableContainer');

    if (!leads || leads.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üì≠</div>
                <p>No leads found</p>
            </div>
        `;
        return;
    }

    const tableHTML = `
        <table class="leads-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Contact</th>
                    <th>Area</th>
                    <th>Intent</th>
                    <th>Budget</th>
                    <th>Score</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                ${leads.map(lead => `
                    <tr>
                        <td><strong>${lead.Name || 'N/A'}</strong></td>
                        <td>
                            <div>${lead.Email || 'N/A'}</div>
                            <div style="font-size: 0.75rem; color: var(--text-tertiary);">
                                ${lead.Phone || 'N/A'}
                            </div>
                        </td>
                        <td>${lead.Area || 'N/A'}</td>
                        <td>
                            <span class="badge badge-${(lead.Intent || 'inquiry').toLowerCase()}">
                                ${lead.Intent || 'Inquiry'}
                            </span>
                        </td>
                        <td>${lead.Budget || 'N/A'}</td>
                        <td>
                            <div class="lead-score">
                                <span>${lead['Lead Score'] || 0}</span>
                                <div class="score-bar">
                                    <div class="score-fill" 
                                         style="width: ${(lead['Lead Score'] || 0)}%;">
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td style="font-size: 0.75rem; color: var(--text-secondary);">
                            ${formatDate(lead.Date)}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    container.innerHTML = tableHTML;
}

// Update Chart
function updateChart(leads) {
    const ctx = document.getElementById('leadsChart');

    const days = [];
    const counts = [];

    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);

        days.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

        const dayStr = d.toISOString().split('T')[0];

        const count = leads.filter(l => l.Date && l.Date.startsWith(dayStr)).length;
        counts.push(count);
    }

    if (leadsChart) leadsChart.destroy();

    leadsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: days,
            datasets: [{
                label: 'New Leads',
                data: counts,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Format Date
function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// Filters
document.getElementById('searchInput').addEventListener('input', filterLeads);
document.getElementById('intentFilter').addEventListener('change', filterLeads);
document.getElementById('sortFilter').addEventListener('change', filterLeads);

function filterLeads() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const intent = document.getElementById('intentFilter').value.toLowerCase();
    const sort = document.getElementById('sortFilter').value;

    let filtered = allLeads.filter(lead => {
        const matchSearch =
            !search ||
            (lead.Name || '').toLowerCase().includes(search) ||
            (lead.Email || '').toLowerCase().includes(search) ||
            (lead.Area || '').toLowerCase().includes(search);

        const matchIntent =
            !intent || (lead.Intent || '').toLowerCase() === intent;

        return matchSearch && matchIntent;
    });

    if (sort === 'date')
        filtered.sort((a, b) => new Date(b.Date) - new Date(a.Date));
    else if (sort === 'score')
        filtered.sort((a, b) => (b['Lead Score'] || 0) - (a['Lead Score'] || 0));
    else if (sort === 'name')
        filtered.sort((a, b) => (a.Name || '').localeCompare(b.Name || ''));

    updateLeadsTable(filtered);
}

// Initial Load
fetchDashboardData();
setInterval(fetchDashboardData, 300000);
</script>
